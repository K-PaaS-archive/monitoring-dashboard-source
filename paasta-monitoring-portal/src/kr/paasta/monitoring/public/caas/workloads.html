<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>PaaS-TA Monitoring</title>
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/c3.min.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/layout.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/layout_custom.css" />
	</head>
	<body>

		<!-- Wrap -->
		<div id="wrap">
			
			<!-- Header -->
			<header>
				<h1><a href="index.html" title="Monitoring"><img src="../resources/img/logo_56x56.png" alt="Monitoring" ></a></h1>

				<ul class="global">
					<li class="PaaS"><a href="../paas/index.html">AP</a></li>
					<li class="CaaS"><a href="index.html" class="top-menu-active">CP</a></li>
					<li class="SaaS"><a href="../saas/index.html">SaaS</a></li>
					<li class="IaaS"><a href="../iaas/index.html">IaaS</a></li>
				</ul>
				
				<!-- Navigation -->
				<nav>
					<ul>
						<li><a href="index.html"><em><img src="../resources/img/nav_home.png" alt="home" ></em></a></li>
						<li><a href="cluster.html">C<span>luster</span></a></li>
						<li><a href="workloads.html" class="on">W<span>orkloads</span></a></li>
						<li><a href="pod.html">P<span>od</span></a></li>
						<li>
							<a href="alarm_definition.html">A<span>larm</span></a>
							<ul>
								<li><a href="alarm_definition.html">Policy</a></li>
								<li><a href="alarm_status.html">Status</a></li>
							</ul>
						</li>
					</ul>
				</nav>
				<!-- // Navigation -->
				
			</header>
			<!-- // Header -->

			<!-- Container -->
			<div id="container">
				<div class="contentsLeft">
					<!-- Overview -->
					<h3>Workloads Status</h3>
					<h5>Deployment Replicas Status</h5>
					<div class="gaugeChart" id="deployment"></div>
					<h5>Stateful Replicas Status</h5>
					<div class="gaugeChart" id="stateful"></div>
					<h5>DaemonSet Status</h5>
					<div class="gaugeChart" id="daemonSet"></div>
					<h5>Pod Container Status</h5>
					<div class="gaugeChart" id="pod"></div>
					<!-- // Overview -->
				</div>

				<!-- Contents -->
				<section id="contents">
					<nav>
						<a href="javascript:void(0);" class="timeSetting"><img src="../resources/img/btn_header_cal.png" alt="calendar" ></a>
						<ul>
							<li>
								<a href="javascript:void(0);" class="alarmView">
									<img src="../resources/img/btn_header_alarm.png" alt="alarm" >
									<img src="../resources/img/btn_header_alarm_on.png" alt="alarm" >
									<span>0</span>
								</a>
							</li>
							<li class="outBtn">
								<a href="javascript:void(0);">
									<img src="../resources/img/btn_header_user.png" alt="user" >
									<div><strong>username</strong><span>username</span></div>
								</a>
							</li>
							<li>
								<a href="javascript:void(0);" class="logout"><img src="../resources/img/btn_header_out.png" alt="user" ><span>Sign Out</span></a>
							</li>
						</ul>
					</nav>
					<div class="timePop">
						<h4>Time Range</h4>
						<div class="timer">
							<div>
								<input type="radio" name="timeRange" id="tr01" value="15">
								<label for="tr01">최근 15분</label>
								<input type="radio" name="timeRange" id="tr02" value="30">
								<label for="tr02">최근 30분</label>
								<input type="radio" name="timeRange" id="tr03" value="60">
								<label for="tr03">최근 1시간</label>
								<input type="radio" name="timeRange" id="tr04" value="180">
								<label for="tr04">최근 3시간</label>
								<input type="radio" name="timeRange" id="tr05" value="360">
								<label for="tr05">최근 6시간</label>
								<input type="radio" name="timeRange" id="tr06" value="720">
								<label for="tr06">최근 12시간</label>
								<input type="radio" name="timeRange" id="tr07" value="1440">
								<label for="tr07">최근 1일</label>
								<input type="radio" name="timeRange" id="tr08" value="10080">
								<label for="tr08">최근 이번주</label>
								<input type="radio" name="timeRange" id="tr09" value="40320">
								<label for="tr09">최근 이번달</label>
							</div>
							<div style="display:none;">
								<input type="radio" name="timeRange" id="tr10">
								<label for="tr10">수동설정</label>
								<input type="text" id="from" name="from">
								<input type="text" id="to" name="to">
							</div>
						</div>
						<h4>Refreshing Time</h4>
						<div class="refresh">
							<div class="select_wrap">
								<select id="timeSelect">
									<option value="0">OFF</option>
									<option value="1">1m</option>
									<option value="5">5m</option>
									<option value="15">15m</option>
									<option value="30">30m</option>
									<option value="60">1h</option>
									<option value="120">2h</option>
									<option value="1440">1d</option>
								</select>
								<label for="timeSelect">OFF</label>
							</div>
						</div>
						<div class="btnWrap center">
							<button class="save">Save Changes</button>
						</div>
						<a href="javascript:void(0);" class="close">close</a>
					</div>

					<article>
						<h4>Workloads Container Summary</h4>
						<div id="workerSummary" class="summaryList"></div>
						<!--<h4>Workloads Status</h4>-->
					</article>
				</section>
				<!-- // Contents -->
			</div>
			<!-- // Container -->
			
			<div id="chartWrap">
				<div class="chart on">
					<h4><span class="chartTitle"></span></h4>
					<ul class="one">
						<li>
							<h5>Workloads Usage</h5>
							<div id="nodeChart" class="gaugeChart"></div>
						</li>
					</ul>
					<h5>Workloads Container list</h5>
					<div class="tableList">
						<table style="table-layout: fixed">
							<caption>Workloads Container list</caption>
							<thead>
								<tr>
									<th width="21%">Container Name</th>
									<th width="14%">Name Space</th>
									<th width="24%">podName</th>
									<th width="8%">CPU<br>(ms)</th>
									<th width="8%">Memory<br>(MB)</th>
									<th width="8%">Disk<br>(GB)</th>
									<th width="8%">CPU<br>Usage</th>
									<th width="8%">Memory<br>Usage</th>
								</tr>
							</thead>
							<tbody id="containerlist">
							</tbody>
						</table>
					</div>

					<!-- // Log Layer -->
					<div class="logWrap">
						<div class="log on">
							<h4>LOG</h4>
							<div id="logChart" class="logChart"></div>
							<pre id="logText"></pre>
							<a href="javascript:void(0);" class="logClosed"></a>
						</div>
					</div>
					<!-- // Log Layer -->
				</div>
				<a href="javascript:void(0);" class="chartClosed"></a>
			</div>

		</div>
		<!-- // Wrap -->

		<script type="text/javascript" src="../resources/js/d3-5.4.0.min.js"></script>
		<script type="text/javascript" src="../resources/js/c3.min.js"></script>
		<script type="text/javascript" src="../resources/js/fn-1.0.js"></script>
		<script type="text/javascript">
			window.onload = () => {
				const workloads = {
					id : '',
					data : [],

					init() {
						// Alarm Count
						fnComm.alarmCount('caas');
						
						// Workloads Status 데이터로드
						fnComm.loadData('GET', fnComm.url + 'caas/monitoring/workloadsStatus', workloads.workloadsStatus);
						
						// Workloads Container Summary 데이터로드
						fnComm.loadData('GET', fnComm.url + 'caas/monitoring/workerloadsConainerSummary', workloads.workloadsSummary);
					},

					gaugeList(data){
						// pod Usage 차트
						fnComm.gaugeChart(data.PodUsage, 'Pod Usage', '#podUsage');

						// CPU Usage 차트
						fnComm.gaugeChart(data.CpuUsage, 'Cpu Usage', '#cpuUsage');

						// Memory Usage 차트
						fnComm.gaugeChart(data.MemoryUsage, 'Memory Usage', '#memoryUsage');

						// Disk Usage 차트
						fnComm.gaugeChart(data.DiskUsage, 'Disk Usage', '#diskUsage');

					},

					workloadsStatus(data) {
						// Alerts: "7"
						// Nodes: "3"
						// PodRestart: "0"
						// RunningContainer: "55"
						// RunningPod: "30"

						
						data.forEach(value => {
							var target ='';
							let arr = [];

							switch(value.Name) {
								case 'Deployment':
									target = '#deployment'
									arr = [
										['Total', 0, value.Total, 0, 0, 0, 0],
										['Available', 0, 0, value.Available, 0, 0, 0],
										['Updated', 0, 0, 0, value.Updated, 0, 0],
										['Unavailable', 0, 0, 0, 0, value.Unavailable, 0]
									];
								break;
								case 'DaemonSet':
									target = '#daemonSet'
									arr = [
										['Ready', 0, value.Ready, 0, 0, 0, 0],
										['Available', 0, 0, value.Available, 0, 0, 0],
										['Misscheduled', 0, 0, 0, value.Misscheduled, 0, 0],
										['Unavailable', 0, 0, 0, 0, value.Unavailable, 0]
									];
								break;
								case 'Stateful':
									target = '#stateful'
									arr = [
										['Total', 0, value.Total, 0, 0, 0, 0],
										['Ready', 0, 0, value.Ready, 0, 0, 0],
										['Updated', 0, 0, 0, value.Updated, 0, 0],
										['Revision', 0, 0, 0, 0, value.Revision, 0]
									];
								break;
								case 'Pod':
									target = '#pod'
									arr = [
										['Ready', 0, value.Ready, 0, 0, 0, 0],
										['Running', 0, 0, value.Running, 0, 0, 0],
										['Restart', 0, 0, 0, value.Restart, 0, 0],
										['terminated', 0, 0, 0, 0, value.terminated, 0]
									];
								break;
							};

							workloads.workloadsChart(target, arr)
						});
					},

					workloadsChart(target, arr){
						var chart = c3.generate({
							bindto: target,
							data: {
								columns: arr,
								labels: true,
								type: 'spline'
							},
							color: {
								pattern: ['#43be42', '#f6a200', '#f4256c', '#c048c8', '#ccc']
							},
							axis: {
								x: {
									show: false
								},
								y: {
									show: false
								}
							},
						});
					},

					workloadsSummary(data) {
						// Data Example //////////////////////////////////////////////////////
						// Cpu: "59447.14"
						// CpuUsage: "0.02"
						// Disk: "74.7"
						// DiskUsage: "0.02"
						// Memory: "353.1"
						// MemoryUsage: "9.54"
						// Name: "deployment"
						//////////////////////////////////////////////////////////////////////
						
						var target = document.getElementById('workerSummary');
						
						fnComm.removeHtml(target);
	
						data.forEach((value, idx)=>{
							var html = `<div class="normal">
								<div>
									<strong><a href="javascript:void(0);">${value.Name}</a></strong>
								</div>
								<div>
									<dl class="color1" title="CPU">
										<dt>C</dt>
										<dd>${value.Cpu} ms</dd>
									</dl>
									<dl class="color2" title="Memory">
										<dt>M</dt>
										<dd>${value.Memory} MB</dd>
									</dl>
									<dl class="color3" title="Disk">
										<dt>D</dt>
										<dd>${value.Disk} GB</dd>
									</dl>
									<dl>
										<dt>CPU Usage</dt>
										<dd>${value.CpuUsage} %</dd>
									</dl>
									<dl>
										<dt>Memory Usage</dt>
										<dd>${value.MemoryUsage} %</dd>
									</dl>
								</div>
								<div class="summaryBtn" data-name="${value.Name}">
									<a href="javascript:void(0);" class="chart"><img src="../resources/img/btn_chart.png" alt="Chart"><span>Chart</span></a>
								</div>
							</div>`
	
							fnComm.appendHtml(target, html, 'div');
						});

						// Application Event (Chart)
						var elm = document.querySelectorAll('.summaryBtn');
						for(var i=0 ; i<elm.length ; i++){
							// Worker Node Info Event
							elm[i].querySelector('.chart').addEventListener('click', (e) => {
								if(e.target.nodeName == 'A'){
									var elmName = e.target.parentNode.getAttribute('data-name');
								} else {
									var elmName = e.target.parentNode.parentNode.getAttribute('data-name');
								};
								
								document.querySelector('.chartTitle').innerHTML = elmName;

								// Workloads Detail Chart 데이터로드
								fnComm.loadData('GET', fnComm.url + `caas/monitoring/workloadsGraph?WorkloadsName=${elmName}`, workloads.nodeInfo);
							
								// Workloads Container list 데이터로드
								fnComm.loadData('GET', fnComm.url + `caas/monitoring/contiList?WorkloadsName=${elmName}`, workloads.containerlist);
							}, false);
						};
							
						// Chart Close Event
						document.querySelector('.chartClosed').addEventListener('click', (e) => {
							document.getElementById('chartWrap').classList.toggle('on', false);
							document.querySelector('.logWrap').classList.toggle('on', false);
						}, false);
							
						// LOG Close Event
						document.querySelector('.logClosed').addEventListener('click', (e) => {
							document.querySelector('.logWrap').classList.toggle('on', false);
						}, false);
					},

					nodeInfo(data){
						document.getElementById('chartWrap').classList.toggle('on', true);

						setTimeout(() => {
							fnComm.detailChart(data, '#nodeChart');
						},500);
					},

					containerlist(data) {
						console.log(data);
						workloads.data = data;
						// ContainerName: "fluentd-gcp-scaler"
						// Cpu: "22522.09"
						// CpuUsage: "0.66"
						// Disk: "23.5"
						// Memory: "82.8"
						// MemoryUsage: "2.24"
						// NameSpace: "kube-system"
						// PodName: "fluentd-gcp-scaler-7b895cbc89-rzqbq"
						
						var target = document.getElementById('containerlist');
						
						fnComm.removeHtml(target);
	
						data.forEach(value => {
							var html = `<tr>
								<td class="left" title="${value.ContainerName}" data-sp="${value.NameSpace}" data-po="${value.PodName}"><a href="javascript:void(0);" class="link contName">${value.ContainerName}</a></td>
								<td class="left" title="${value.NameSpace}">${value.NameSpace}</td>
								<td class="left" title="${value.PodName}">${value.PodName}</td>
								<td>${value.Cpu}</td>
								<td>${value.Memory}</td>
								<td>${value.Disk}</td>
								<td>${value.CpuUsage}</td>
								<td>${value.MemoryUsage}</td>
							</tr>`;
							
							fnComm.appendHtml(target, html, 'tbody');
						});

						// Container Event (Log)
						var elm = document.querySelectorAll('.contName');
						for(var i=0 ; i<elm.length ; i++){
							// Pod Node Info Event
							elm[i].addEventListener('click', (e) => {
								var containerName = e.target.parentNode.getAttribute('title');
								var nameSpace = e.target.parentNode.getAttribute('data-sp');
								var podName = e.target.parentNode.getAttribute('data-po');
							
								// Container Chart 데이터로드
								fnComm.loadData('GET', fnComm.url + `caas/monitoring/containerGraph?ContainerName=${containerName}&NameSpace=${nameSpace}&PodName=${podName}`, workloads.containerChart);
								
								// Container Log 데이터로드
								fnComm.loadData('GET', fnComm.url + `caas/monitoring/contiInfoLog?ContainerName=${containerName}&NameSpace=${nameSpace}&PodName=${podName}`, workloads.containerLog);
							}, false);
						};
							
						// Chart Close Event
						document.querySelector('.logClosed').addEventListener('click', (e) => {
							document.querySelector('.logWrap').classList.toggle('on', false);
						}, false);
					},

					containerChart(data) {
						document.querySelector('.logWrap').classList.toggle('on', true);

						setTimeout(() => {
							fnComm.detailChart(data, '#logChart');
						},500);
					},

					containerLog(data) {
						document.getElementById('logText').innerHTML = data;
					},

					sortList() {
						workloads.data.sort(function(a,b) {
							return parseFloat(a[sortData]) - parseFloat(b[sortData]);
						});

						workloads.containerlist(workloads.data);
					},
				}
	
				workloads.init();
			};
		</script>
	</body>
</html>