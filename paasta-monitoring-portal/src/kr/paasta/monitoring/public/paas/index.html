<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>PaaS-TA Monitoring</title>
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/c3.min.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/layout.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/layout_custom.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/jquery.orgchart.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="../resources/css/diagram_style.css" />
	</head>
	<body>

		<!-- Wrap -->
		<div id="wrap">
			
			<!-- Header -->
			<header>
				<h1><a href="../index.html" title="Monitoring"><img src="../resources/img/logo_56x56.png" alt="Monitoring" ></a></h1>
				
				<ul class="global">
					<li class="PaaS"><a href="#" class="top-menu-active">AP</a></li>
					<li class="CaaS"><a href="../caas/index.html">CP</a></li>
					<li class="SaaS"><a href="../saas/index.html">SaaS</a></li>
					<li class="IaaS"><a href="../iaas/index.html">IaaS</a></li>
				</ul>
				
				<!-- Navigation -->
				<nav>
					<ul>
						<li><a href="index.html" class="on"><em><img src="../resources/img/nav_home.png" alt="home" ></em></a></li>
						<li><a href="bosh.html">B<span>OSH</span></a></li>
						<li><a href="paas.html">P<span>aaS-TA</span></a></li>
						<li><a href="cont.html">C<span>ontainer</span></a></li>
						<li>
							<a href="alarm_policy.html">A<span>larm</span></a>
							<ul>
								<li><a href="alarm_policy.html">Policy</a></li>
								<li><a href="alarm_status.html">Status</a></li>
								<li><a href="alarm_statis.html">Statistics</a></li>
							</ul>
						</li>
					</ul>
				</nav>
				<!-- // Navigation -->
				
			</header>
			<!-- // Header -->

			<ul class="global">
				<li><a href="../paas/index.html">PaaS</a></li>
				<li><a href="../saas/index.html">SaaS</a></li>
				<li><a href="../caas/index.html">CaaS</a></li>
				<li><a href="../iaas/index.html">IaaS</a></li>
			</ul>

			<!-- Container -->
			<div id="container">
				<div class="contentsLeft">
					<!-- Overview -->
					<h3>BOSH</h3>
					<div class="chartView" id="boshChart"></div>
					<h3>PaaS-TA</h3>
					<div class="chartView" id="paasChart"></div>
					<h3>Container</h3>
					<div class="chartView" id="contChart"></div>
					<!-- // Overview -->
				</div>

				<!-- Contents -->
				<section id="contents">
					<nav>
						<a href="javascript:void(0);" class="timeSetting"><img src="../resources/img/btn_header_cal.png" alt="calendar" ></a>
						<ul>
							<li>
								<a href="javascript:void(0);" class="alarmView">
									<img src="../resources/img/btn_header_alarm.png" alt="alarm" >
									<img src="../resources/img/btn_header_alarm_on.png" alt="alarm" >
									<span>0</span>
								</a>
							</li>
							<li class="outBtn">
								<a href="javascript:void(0);">
									<img src="../resources/img/btn_header_user.png" alt="user" >
									<div><strong>username</strong><span>username</span></div>
								</a>
							</li>
							<li>
								<a href="javascript:void(0);" class="logout"><img src="../resources/img/btn_header_out.png" alt="user" ><span>Sign Out</span></a>
							</li>
						</ul>
					</nav>
					<div class="timePop">
						<h4>Time Range</h4>
						<div class="timer">
							<div>
								<input type="radio" name="timeRange" id="tr01" value="15m" data-group="1m" checked>
								<label for="tr01">최근 15분</label>
								<input type="radio" name="timeRange" id="tr02" value="30m" data-group="2m">
								<label for="tr02">최근 30분</label>
								<input type="radio" name="timeRange" id="tr03" value="1h" data-group="4m">
								<label for="tr03">최근 1시간</label>
								<input type="radio" name="timeRange" id="tr04" value="3h" data-group="12m">
								<label for="tr04">최근 3시간</label>
								<input type="radio" name="timeRange" id="tr05" value="6h" data-group="24m">
								<label for="tr05">최근 6시간</label>
								<input type="radio" name="timeRange" id="tr06" value="12h" data-group="48m">
								<label for="tr06">최근 12시간</label>
								<input type="radio" name="timeRange" id="tr07" value="1d" data-group="1h36m">
								<label for="tr07">최근 1일</label>
								<input type="radio" name="timeRange" id="tr08" value="7d" data-group="11h12m">
								<label for="tr08">최근 이번주</label>
								<input type="radio" name="timeRange" id="tr09" value="30d" data-group="48h">
								<label for="tr09">최근 이번달</label>
							</div>
							<div style="display:none;">
								<input type="radio" name="timeRange" id="tr10">
								<label for="tr10">수동설정</label>
								<input type="text" id="from" name="from">
								<input type="text" id="to" name="to">
							</div>
						</div>
						<!--
						<h4>Refreshing Time</h4>
						<div class="refresh">
							<select id="timeSelect">
								<option value="0">OFF</option>
								<option value="1m">1m</option>
								<option value="5m">5m</option>
								<option value="15m">15m</option>
								<option value="30m">30m</option>
								<option value="1h">1h</option>
								<option value="2h">2h</option>
								<option value="1d">1d</option>
							</select>
						</div>
						<div class="btnWrap center">
							<button class="save">Save Changes</button>
						</div>
					-->
						<a href="javascript:void(0);" class="close">close</a>
					</div>
					<article>
						<h4>PaaS App Overview</h4>
						<div id="diagramContainer"></div>
					</article>
					<article class="zoneWrap">
						<h4>
							<span>Zone-Containers View</span>
							<select id="containerZone">
							</select>
						</h4>
						<div class="cellList">
						</div>
					</article>

					<article class="alarmWrap">
						<h4>Alarm Issue View</h4>
						<ul class="alarmList">
						</ul>
					</article>
					
				</section>
				<!-- // Contents -->

			</div>
			<!-- // Container -->

			<div id="chartWrap">
					<h4><span class="chartTitle"></span></h4>
					<ul class="chart">
						<li>
							<h5>CPU Usage</h5>
							<div id="cpuUsageChart"></div>
						</li>
						<li>
							<h5>CPU Load Average</h5>
							<div id="cpuLoadChart"></div>
						</li>
						<li>
							<h5>Memory Usage</h5>
							<div id="memoryUsageChart"></div>
						</li>
						<li>
							<h5>Disk Usage</h5>
							<div id="diskUsageChart"></div>
						</li>
						<li>
							<h5>Network IO Byte</h5>
							<div id="networkByteChart"></div>
						</li>
						<li>
							<h5>Network IO Drop</h5>
							<div id="networkDropChart"></div>
						</li>
						<li>
							<h5>Network IO Error</h5>
							<div id="networkErrorChart"></div>
						</li>
					</ul>
					<a href="javascript:void(0);" class="chartClosed"></a>
				</div>
		</div>
		<!-- // Wrap -->
		<div id="loadWrap">
			<div class="loader">
				<svg viewBox="0 0 80 80">
					<rect x="8" y="8" width="64" height="64"></rect>
				</svg>
			</div>
		</div>
	</body>

	<script type="text/javascript" src="../resources/js/utils.js"></script>
	<script type="text/javascript" src="../resources/js/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="../resources/js/jquery.orgchart.min.js"></script>
	<script type="text/javascript" src="../resources/js/d3-5.4.0.min.js"></script>
	<script type="text/javascript" src="../resources/js/c3.min.js"></script>
	<script type="text/javascript" src="../resources/js/fn-1.0.js"></script>
	<script type="text/javascript">
		window.onload = () => {
			const main = {
				init() {
					// Alarm Count
					fnComm.alarmCount('paas');
					
					// BOSH 컨디션 차트
					fnComm.loadData('GET', `${fnComm.url}paas/bosh/overview`, fnComm.boshConditionChart);
					// PaaS 컨디션 차트
					fnComm.loadData('GET', `${fnComm.url}paas/paasta/overview`, fnComm.paasConditionChart);
					// CONTAINER 컨디션 차트
					fnComm.loadData('GET', `${fnComm.url}paas/container/overview`, fnComm.contConditionChart);

					// CONTAINER 컨디션 리스트 - 셀렉트 생성
					fnComm.loadData('GET', `${fnComm.url}paas/container/summary?pageIndex=1&pageItems=1000`, main.zoneCreateSelect);

					
					// 오늘 날짜
					var today = new Date();
					var dd = today.getDate();
					var mm = today.getMonth()+1;
					var nn = today.getMonth();
					var yyyy = today.getFullYear();

					if(dd < 10) dd = '0'+dd;
					if(mm < 10) mm = '0'+mm;
					if(nn < 10) nn = '0'+nn;
					
					fnComm.loadData('GET', `${fnComm.url}paas/alarm/statuses?pageItems=1000&pageIndex=1&originType=&alarmType=&resolveStatus=&level=&searchDateFrom=${yyyy}-${nn}-${dd}&searchDateTo=${yyyy}-${mm}-${dd}`, main.alarmCreateList);

					var target = document.getElementById('containerZone');
					target.addEventListener('change', () => {
						let zoneValue = target.options[target.selectedIndex].value;
						console.log(zoneValue);
						
						fnComm.loadData('GET', `${fnComm.url}paas/container/relationship/${zoneValue}`, main.zoneCreateList);
						//main.zoneCreateList(zoneValue);
					});

					//document.getElementById('loadWrap').style.display = 'none';
				},

				zoneCreateSelect(data) {
					//////////////////////////////////////////////////////////////////////
					// 메인 그리드 Zone-Containers : 셀렉터
					// Data Example //////////////////////////////////////////////////////
					// appCnt: "1"
					// cellCnt: "1"
					// cellName: ""
					// containerCnt: "2"
					// criticalCnt: "0"
					// failedCnt: "0"
					// runningCnt: "2"
					// warningCnt: "0"
					// zoneName: "z1"
					//////////////////////////////////////////////////////////////////////
					var target = document.getElementById('containerZone');
					
					fnComm.removeHtml(target);

					data.data.forEach(value => {
						var html = `<option value="${value.zoneName}">Cell-${value.zoneName} / ${value.cellCnt}</option>`;
						
						fnComm.appendHtml(target, html, 'select');
					});

					target.options[0].selected = true;
					
					// CONTAINER 컨디션 리스트 - 상세이스트 생성
					fnComm.loadData('GET', `${fnComm.url}paas/container/relationship/${data.data[0].zoneName}`, main.zoneCreateList);
				},
				
				zoneCreateList(data) {
					//////////////////////////////////////////////////////////////////////
					// 메인 그리드 Zone-Containers : 리스트
					// Data Example //////////////////////////////////////////////////////
					// appCnt: "1"
					// cellCnt: ""
					// cellIp: "10.20.10.136"
					// cellName: "diego-cell/0"
					// containerCnt: "2"
					// containers: (2) [{
					//   0: {
					//     appName: "hello",
					//     appIndex: "1",
					//     status: "running",
					//     containerId: "wqsq7f3rfsfp-0"
					//   }
					// }]
					// criticalCnt: "0"
					// failedCnt: "0"
					// runningCnt: "2"
					// warningCnt: "0"
					// zoneName: "z1"
					//////////////////////////////////////////////////////////////////////
					var target = document.querySelector('.cellList');

					fnComm.removeHtml(target);

					console.log('removeHtml');

					// cell 데이터 있을 시 실행
					if(data != null && data.length > 0){
						data.forEach((value, idx)=>{
							var html = `<dl>
								<dt>${value.cellName}</dt>
							<dd>`;

							// containers 데이터 있을 시 실행
							if(value.containers != null && value.containers.length > 0){
								value.containers.forEach((value, idx)=>{
									html += `<a href="javascript:void(0);" class="contChart ${value.status}" data-id="${value.containerId}" data-name="${value.appName}">
										<div class="flag">
											<dl>
												<dt>Index</dt>
												<dd>${value.appIndex}</dd>
											</dl>
											<dl>
												<dt>Name</dt>
												<dd>${value.appName}</dd>
											</dl>
										</div>
									</a>`;
								});
							};

							html += '</dd></dl>';
							
							fnComm.appendHtml(target, html, 'div');
						});
						
						// Button Event (Process, Chart, Log)
						var elm = document.querySelectorAll('.contChart');
						for(var i=0 ; i<elm.length ; i++){
							// Chart Event
							elm[i].addEventListener('click', (e) => {
								document.querySelector('.chartTitle').innerHTML = e.target.getAttribute('data-name');
								main.chartView(e.target.getAttribute('data-id'));
							}, false);
							
							// Chart Event
							document.querySelector('.chartClosed').addEventListener('click', (e) => {
								document.getElementById('chartWrap').classList.toggle('on', false);
							}, false);
						};
						
					};
				},

				chartView(elmID) {
					document.getElementById('chartWrap').classList.toggle('on', true);
					document.getElementById('chartWrap').querySelector('.chart').classList.toggle('on', true);

					setTimeout(() => {
						// CPU Usage 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/cpu/${elmID}/usages` + fnComm.setTimer(), fnComm.detailChart, '#cpuUsageChart');

						// CPU Load 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/cpu/${elmID}/loads` + fnComm.setTimer(), fnComm.detailChart, '#cpuLoadChart');

						// Memory Usage 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/memory/${elmID}/usages` + fnComm.setTimer(), fnComm.detailChart, '#memoryUsageChart');

						// Disk Usage 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/disk/${elmID}/usages` + fnComm.setTimer(), fnComm.detailChart, '#diskUsageChart');

						// Network IO Bytes 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/network/${elmID}/bytes` + fnComm.setTimer(), fnComm.detailChart, '#networkByteChart');
						
						// Network IO Drop 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/network/${elmID}/drops` + fnComm.setTimer(), fnComm.detailChart, '#networkDropChart');
						
						// Network IO Error 정보
						fnComm.loadData('GET', `${fnComm.url}paas/container/network/${elmID}/errors` + fnComm.setTimer(), fnComm.detailChart, '#networkErrorChart');
					},500);
				},

				alarmCreateList(data) {
					var target = document.querySelector('.alarmList');

					fnComm.removeHtml(target);

					if(data.data.length > 0){
						data.data.forEach(value => {
							var html = `<li class="${value.level}">
								<h6><span>${value.regDate}</span></h6>
								<dl>
									<dt>Type</dt>
									<dd>${value.alarmType}</dd>
								</dl>
								<dl>
									<dt>Title</dt>
									<dd>${value.alarmTitle}</dd>
								</dl>
							</li>`;

							fnComm.appendHtml(target, html, 'div');
						});

						fnComm.linkHtml(document.querySelector('.alarmList').querySelectorAll('li'), 'alarm_status.html');
					} else {
						var html = `<li class="none">최근 한달간 알람이 없습니다.</li>`

						fnComm.appendHtml(target, html, 'div');
					}
				},
			}

			main.init();

			Utils.requestHttp(`${fnComm.url}paas/diagram`, 'GET', null, null).then(function(data){
				console.log(data);

				var options = {
					'data' : data,
					'nodeContent' : 'title',
					'direction' : 't2b',
					'pan' : true,
					'zoom' : true,
					'verticalLevel' : 4,
					'parentNodeSymbol' : ''
				};
				var dc = $("#diagramContainer").orgchart(options);
				$('.orgchart').addClass('noncollapsable');
			});

		};
	</script>
</html>
